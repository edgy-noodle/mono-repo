---
- name: Install k8s packages
  hosts: k8s
  become: true
  tasks:

  - name: Install updates
    apt:
      upgrade: true
      update_cache: yes

  - name: Disable SWAP
    shell: |
      swapoff -a

  - name: Disable SWAP in fstab
    replace:
      path: /etc/fstab
      regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
      replace: '# \1'

  - name: Reboot
    reboot:

  - name: Install util packages
    package:
      name:
        - bash-completion
        - bridge-utils
        - net-tools
        - cloud-utils
        - containerd
        - ca-certificates
      update_cache: yes
      state: latest

  - name: Load overlay module
    community.general.modprobe:
      name: overlay
      persistent: present

  - name: Load br_netfilter module
    community.general.modprobe:
      name: br_netfilter
      persistent: present

  - name: Copy 99-kubernetes-cri.conf CRI config
    copy:
      src: ../configs/k8s/99-kubernetes-cri.conf
      dest: /etc/sysctl.d/99-kubernetes-cri.conf
      owner: edgy
      group: edgy
      mode: 0644

  - name: Create containerd directory
    file:
      path: /etc/containerd
      state: directory

  - name: Generate containerd config
    shell: |
      containerd config default | sudo tee /etc/containerd/config.toml
      
  - name: Change SystemdCgroup to true in containerd config
    replace:
      path: /etc/containerd/config.toml
      regexp: '            SystemdCgroup = false'
      replace: '            SystemdCgroup = true'

  - name: Reload configs
    systemd:
      daemon_reload: true

  - name: Create keyrings directory
    file:
      path: /etc/apt/keyrings
      state: directory

  - name: Download k8s keys
    get_url:
      url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
      dest: /etc/apt/keyrings/kubernetes-archive-keyring.asc
      mode: 0644

  - name: Add k8s package repos
    deb822_repository:
      name: kubernetes
      types: deb
      suites: kubernetes-xenial
      components: main
      uris: https://apt.kubernetes.io/
      signed_by: /etc/apt/keyrings/kubernetes-archive-keyring.asc

  - name: Install k8s packages
    tags: k8s
    package:
      name:
        - kubelet
        - kubeadm
        - kubectl
      update_cache: yes
      state: latest

  - name: Disable automatic update for kubelet package
    dpkg_selections:
      name: kubelet
      selection: hold

  - name: Disable automatic update for kubeadm package
    dpkg_selections:
      name: kubeadm
      selection: hold

  - name: Disable automatic update for kubectl package
    dpkg_selections:
      name: kubectl
      selection: hold

  - name: Enable kubelet service
    systemd:
      name: kubelet
      enabled: true
      state: started

  - name: Enable containerd service
    systemd:
      name: containerd
      enabled: true
      state: restarted