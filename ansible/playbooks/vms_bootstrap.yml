---
- name: Bootstrap VMs, preliminary tasks and checks
  hosts: all
  become: true
  remote_user: edgy
  become_method: su
  tasks:
    - name: Install sudo
      package:
        name: sudo
        state: latest
        update_cache: yes

    - name: Create ansible user
      user:
        name: ansible
        groups:
          - ansible
          - sudo
      register: ansible

    - name: Run sudo without password
      community.general.sudoers:
        group: ansible
        nopassword: true

    - name: Add SSH key for ansible user
      authorized_key:
        user: ansible
        key: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIAqWyHzwXS1oXk+Ir04eULYLBFT1nLIu7yoYGWlfq9Hy ansible"

    - name: Install updates
      apt:
        upgrade: true
        update_cache: yes
      register: updated

    - name: Restart if updated
      reboot:
      when: ansible.changed or updated.changed
